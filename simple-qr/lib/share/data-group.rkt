#lang racket

(provide (contract-out
     [get-group-width (-> exact-nonnegative-integer? string? vector?)]
     [defines->count-list (-> vector? list?)]
     [count_list->sequence_list (-> list? list?)]
     [sequence_list->sequence (-> (listof list?) list?)]
     [split-data->groups (-> string? exact-nonnegative-integer? list?)]
     [combine-data-sequence (-> (listof string?) (listof exact-nonnegative-integer?) (listof pair?))]
     [rearrange-data (-> string? list? string?)]
     ))

(define (get-group-width version error_level)
  (let ([group_map
         '#hash(
                ("1-L" . #((1 . 19) (0 . 0)))
                ("1-M" . #((1 . 16) (0 . 0)))
                ("1-Q" . #((1 . 13) (0 . 0)))
                ("1-H" . #((1 . 9) (0 . 0)))
                ("2-L" . #((1 . 34) (0 . 0)))
                ("2-M" . #((1 . 28) (0 . 0)))
                ("2-Q" . #((1 . 22) (0 . 0)))
                ("2-H" . #((1 . 16) (0 . 0)))
                ("3-L" . #((1 . 55) (0 . 0)))
                ("3-M" . #((1 . 44) (0 . 0)))
                ("3-Q" . #((2 . 17) (0 . 0)))
                ("3-H" . #((2 . 13) (0 . 0)))
                ("4-L" . #((1 . 80) (0 . 0)))
                ("4-M" . #((2 . 32) (0 . 0)))
                ("4-Q" . #((2 . 24) (0 . 0)))
                ("4-H" . #((4 . 9) (0 . 0)))
                ("5-L" . #((1 . 108) (0 . 0)))
                ("5-M" . #((2 . 43) (0 . 0)))
                ("5-Q" . #((2 . 15) (2 . 16)))
                ("5-H" . #((2 . 11) (2 . 12)))
                ("6-L" . #((2 . 68) (0 . 0)))
                ("6-M" . #((4 . 27) (0 . 0)))
                ("6-Q" . #((4 . 19) (0 . 0)))
                ("6-H" . #((4 . 15) (0 . 0)))
                ("7-L" . #((2 . 78) (0 . 0)))
                ("7-M" . #((4 . 31) (0 . 0)))
                ("7-Q" . #((2 . 14) (4 . 15)))
                ("7-H" . #((4 . 13) (1 . 14)))
                ("8-L" . #((2 . 97) (0 . 0)))
                ("8-M" . #((2 . 38) (2 . 39)))
                ("8-Q" . #((4 . 18) (2 . 19)))
                ("8-H" . #((4 . 14) (2 . 15)))
                ("9-L" . #((2 . 116) (0 . 0)))
                ("9-M" . #((3 . 36) (2 . 37)))
                ("9-Q" . #((4 . 16) (4 . 17)))
                ("9-H" . #((4 . 12) (4 . 13)))
                ("10-L" . #((2 . 68) (2 . 69)))
                ("10-M" . #((4 . 43) (1 . 44)))
                ("10-Q" . #((6 . 19) (2 . 20)))
                ("10-H" . #((6 . 15) (2 . 16)))
                ("11-L" . #((4 . 81) (0 . 0)))
                ("11-M" . #((1 . 50) (4 . 51)))
                ("11-Q" . #((4 . 22) (4 . 23)))
                ("11-H" . #((3 . 12) (8 . 13)))
                ("12-L" . #((2 . 92) (2 . 93)))
                ("12-M" . #((6 . 36) (2 . 37)))
                ("12-Q" . #((4 . 20) (6 . 21)))
                ("12-H" . #((7 . 14) (4 . 15)))
                ("13-L" . #((4 . 107) (0 . 0)))
                ("13-M" . #((8 . 37) (1 . 38)))
                ("13-Q" . #((8 . 20) (4 . 21)))
                ("13-H" . #((12 . 11) (4 . 12)))
                ("14-L" . #((3 . 115) (1 . 116)))
                ("14-M" . #((4 . 40) (5 . 41)))
                ("14-Q" . #((11 . 16) (5 . 17)))
                ("14-H" . #((11 . 12) (5 . 13)))
                ("15-L" . #((5 . 87) (1 . 88)))
                ("15-M" . #((5 . 41) (5 . 42)))
                ("15-Q" . #((5 . 24) (7 . 25)))
                ("15-H" . #((11 . 12) (7 . 13)))
                ("16-L" . #((5 . 98) (1 . 99)))
                ("16-M" . #((7 . 45) (3 . 46)))
                ("16-Q" . #((15 . 19) (2 . 20)))
                ("16-H" . #((3 . 15) (13 . 16)))
                ("17-L" . #((1 . 107) (5 . 108)))
                ("17-M" . #((10 . 46) (1 . 47)))
                ("17-Q" . #((1 . 22) (15 . 23)))
                ("17-H" . #((2 . 14) (17 . 15)))
                ("18-L" . #((5 . 120) (1 . 121)))
                ("18-M" . #((9 . 43) (4 . 44)))
                ("18-Q" . #((17 . 22) (1 . 23)))
                ("18-H" . #((2 . 14) (19 . 15)))
                ("19-L" . #((3 . 113) (4 . 114)))
                ("19-M" . #((3 . 44) (11 . 45)))
                ("19-Q" . #((17 . 21) (4 . 22)))
                ("19-H" . #((9 . 13) (16 . 14)))
                ("20-L" . #((3 . 107) (5 . 108)))
                ("20-M" . #((3 . 41) (13 . 42)))
                ("20-Q" . #((15 . 24) (5 . 25)))
                ("20-H" . #((15 . 15) (10 . 16)))
                ("21-L" . #((4 . 116) (4 . 117)))
                ("21-M" . #((17 . 42) (0 . 0)))
                ("21-Q" . #((17 . 22) (6 . 23)))
                ("21-H" . #((19 . 16) (6 . 17)))
                ("22-L" . #((2 . 111) (7 . 112)))
                ("22-M" . #((17 . 46) (0 . 0)))
                ("22-Q" . #((7 . 24) (16 . 25)))
                ("22-H" . #((34 . 13) (0 . 0)))
                ("23-L" . #((4 . 121) (5 . 122)))
                ("23-M" . #((4 . 47) (14 . 48)))
                ("23-Q" . #((11 . 24) (14 . 25)))
                ("23-H" . #((16 . 15) (14 . 16)))
                ("24-L" . #((6 . 117) (4 . 118)))
                ("24-M" . #((6 . 45) (14 . 46)))
                ("24-Q" . #((11 . 24) (16 . 25)))
                ("24-H" . #((30 . 16) (2 . 17)))
                ("25-L" . #((8 . 106) (4 . 107)))
                ("25-M" . #((8 . 47) (13 . 48)))
                ("25-Q" . #((7 . 24) (22 . 25)))
                ("25-H" . #((22 . 15) (13 . 16)))
                ("26-L" . #((10 . 114) (2 . 115)))
                ("26-M" . #((19 . 46) (4 . 47)))
                ("26-Q" . #((28 . 22) (6 . 23)))
                ("26-H" . #((33 . 16) (4 . 17)))
                ("27-L" . #((8 . 122) (4 . 123)))
                ("27-M" . #((22 . 45) (3 . 46)))
                ("27-Q" . #((8 . 23) (26 . 24)))
                ("27-H" . #((12 . 15) (28 . 16)))
                ("28-L" . #((3 . 117) (10 . 118)))
                ("28-M" . #((3 . 45) (23 . 46)))
                ("28-Q" . #((4 . 24) (31 . 25)))
                ("28-H" . #((11 . 15) (31 . 16)))
                ("29-L" . #((7 . 116) (7 . 117)))
                ("29-M" . #((21 . 45) (7 . 46)))
                ("29-Q" . #((1 . 23) (37 . 24)))
                ("29-H" . #((19 . 15) (26 . 16)))
                ("30-L" . #((5 . 115) (10 . 116)))
                ("30-M" . #((19 . 47) (10 . 48)))
                ("30-Q" . #((15 . 24) (25 . 25)))
                ("30-H" . #((23 . 15) (25 . 16)))
                ("31-L" . #((13 . 115) (3 . 116)))
                ("31-M" . #((2 . 46) (29 . 47)))
                ("31-Q" . #((42 . 24) (1 . 25)))
                ("31-H" . #((23 . 15) (28 . 16)))
                ("32-L" . #((17 . 115) (0 . 0)))
                ("32-M" . #((10 . 46) (23 . 47)))
                ("32-Q" . #((10 . 24) (35 . 25)))
                ("32-H" . #((19 . 15) (35 . 16)))
                ("33-L" . #((17 . 115) (1 . 116)))
                ("33-M" . #((14 . 46) (21 . 47)))
                ("33-Q" . #((29 . 24) (19 . 25)))
                ("33-H" . #((11 . 15) (46 . 16)))
                ("34-L" . #((13 . 115) (6 . 116)))
                ("34-M" . #((14 . 46) (23 . 47)))
                ("34-Q" . #((44 . 24) (7 . 25)))
                ("34-H" . #((59 . 16) (1 . 17)))
                ("35-L" . #((12 . 121) (7 . 122)))
                ("35-M" . #((12 . 47) (26 . 48)))
                ("35-Q" . #((39 . 24) (14 . 25)))
                ("35-H" . #((22 . 15) (41 . 16)))
                ("36-L" . #((6 . 121) (14 . 122)))
                ("36-M" . #((6 . 47) (34 . 48)))
                ("36-Q" . #((46 . 24) (10 . 25)))
                ("36-H" . #((2 . 15) (64 . 16)))
                ("37-L" . #((17 . 122) (4 . 123)))
                ("37-M" . #((29 . 46) (14 . 47)))
                ("37-Q" . #((49 . 24) (10 . 25)))
                ("37-H" . #((24 . 15) (46 . 16)))
                ("38-L" . #((4 . 122) (18 . 123)))
                ("38-M" . #((13 . 46) (32 . 47)))
                ("38-Q" . #((48 . 24) (14 . 25)))
                ("38-H" . #((42 . 15) (32 . 16)))
                ("39-L" . #((20 . 117) (4 . 118)))
                ("39-M" . #((40 . 47) (7 . 48)))
                ("39-Q" . #((43 . 24) (22 . 25)))
                ("39-H" . #((10 . 15) (67 . 16)))
                ("40-L" . #((19 . 118) (6 . 119)))
                ("40-M" . #((18 . 47) (31 . 48)))
                ("40-Q" . #((34 . 24) (34 . 25)))
                ("40-H" . #((20 . 15) (61 . 16))))])

  (hash-ref group_map (string-append (number->string version) "-" error_level))))

(define (defines->count-list defines)
  (let loop ([loop_defines (vector->list defines)]
             [result_list '()])
    (if (not (null? loop_defines))
        (loop
         (cdr loop_defines)
         (append
          (let loop-count ([occur_count (caar loop_defines)]
                           [inner_list '()])
            (if (> occur_count 0)
                (loop-count
                 (sub1 occur_count)
                 (cons (cdar loop_defines) inner_list))
                inner_list))
          result_list))
        (reverse result_list))))

(define (count_list->sequence_list count_list)
  (let loop ([loop_list count_list]
             [count 0]
             [result_list '()])
    (if (not (null? loop_list))
        (loop
         (cdr loop_list)
         (+ count (car loop_list))
         (cons 
          (let inner-loop ([loop_count (car loop_list)]
                           [start_count count]
                           [inner_result_list '()])
            (if (> loop_count 0)
                (inner-loop (sub1 loop_count) (add1 start_count) (cons start_count inner_result_list))
                (reverse inner_result_list)))
          result_list))
        (reverse result_list))))

(define (sequence_list->sequence sequence_list)
  (let ([max_length (apply max (map (lambda (row) (length row)) sequence_list))])
    (let loop ([col_index 0]
               [result_list '()])
      (if (< col_index max_length)
          (loop
           (add1 col_index)
           (cons
            (let inner-loop ([row_index 0]
                             [inner_result_list '()])
              (if (< row_index (length sequence_list))
                  (if (< col_index (length (list-ref sequence_list row_index)))
                      (inner-loop (add1 row_index) (cons (list-ref (list-ref sequence_list row_index) col_index) inner_result_list))
                      (inner-loop (add1 row_index) inner_result_list))
                  (reverse inner_result_list)))
            result_list))
          (flatten (reverse result_list))))))

(define (split-data->groups data_str group_count)
  (let loop ([loop_count group_count]
             [loop_str data_str]
             [result_list '()])
    (if (> loop_count 0)
        (loop 
         (sub1 loop_count)
         (substring loop_str 8)
         (cons (substring loop_str 0 8) result_list))
        (reverse result_list))))

(define (combine-data-sequence data_list sequence_list)
  (let loop ([data_loop data_list]
             [sequence_loop sequence_list]
             [result_list '()])
    (if (not (null? data_loop))
        (loop
         (cdr data_loop)
         (cdr sequence_loop)
         (cons (cons (car data_loop) (car sequence_loop)) result_list))
        (reverse result_list))))

(define (rearrange-data data_bits data_group)
  (foldr
   (lambda (a b)
     (string-append a b))
   ""
   (map
    (lambda (rec)
      (car rec))
    (sort
     (combine-data-sequence
      (split-data->groups data_bits (apply + data_group))
      (sequence_list->sequence (count_list->sequence_list data_group)))
     <
     #:key cdr))))

